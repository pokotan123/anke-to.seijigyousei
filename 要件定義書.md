# アンケート・投票システム 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
アンケート・投票システム（リアルタイム可視化対応）

### 1.2 目的
不特定多数のユーザーに対して質問を配信し、投票結果をリアルタイムで可視化するBIツール機能を備えたWebアプリケーションとしてのアンケートシステムを構築する。

### 1.3 システム種別
- **Webアプリケーション**: ブラウザベースのアプリケーション
- **アクセス方式**: URLによる直接アクセス（認証不要）
- **同時アクセス対応**: 1,000人以上の同時アクセスに対応

### 1.4 背景
- 大規模なアンケート・投票の実施と管理
- リアルタイムでの投票状況の可視化
- 投票結果の分析とレポート機能の提供
- URL共有による簡単なアンケート配信

## 2. システム概要

### 2.1 システム構成
本システムは以下の3つの主要コンポーネントで構成される：

1. **投票者向けインターフェース**
   - 不特定多数のユーザーがアクセス可能な投票画面
   - ユニークなURLによるアクセス（認証不要）
   - 質問への回答機能

2. **管理画面**
   - 質問・アンケートの作成・編集・削除
   - アンケートの管理（公開/非公開、期間設定など）
   - ダッシュボード閲覧機能

3. **ダッシュボード（BIツール機能）**
   - リアルタイムでの投票状況可視化
   - 投票結果の分析とグラフ表示
   - 誰がどこにどのくらい投票しているかの可視化

### 2.2 対象ユーザー

#### 2.2.1 投票者
- 不特定多数の一般ユーザー
- 認証不要（または簡易認証）
- 投票画面のみアクセス可能

#### 2.2.2 管理者
- システム管理者
- 認証必須
- 管理画面とダッシュボードにアクセス可能

## 3. 機能要件

> **機能一覧**: 詳細な機能一覧は [機能一覧.md](./機能一覧.md) を参照してください。

### 3.1 投票者向け機能

#### 3.1.1 投票画面表示
- **機能**: 公開中のアンケート・質問を表示
- **詳細**:
  - アンケートタイトル、説明文の表示
  - 質問文と選択肢の表示
  - 投票ボタンの表示
  - レスポンシブデザイン対応（PC・スマートフォン）

#### 3.1.2 投票実行
- **機能**: 質問に対する投票を実行
- **詳細**:
  - 選択肢からの選択
  - 投票送信
  - 投票完了メッセージの表示
  - 重複投票の防止（同一ユーザー・同一質問への再投票制限）

#### 3.1.3 投票結果確認（オプション）
- **機能**: 投票後の結果を確認（管理者が許可した場合）
- **詳細**:
  - 集計結果の表示
  - グラフ表示（管理者設定による）

### 3.2 管理画面機能

#### 3.2.1 認証機能
- **機能**: 管理者認証
- **詳細**:
  - ログイン画面
  - ユーザー名・パスワード認証
  - セッション管理
  - ログアウト機能

#### 3.2.2 質問管理機能
- **機能**: 質問の作成・編集・削除
- **詳細**:
  - 質問文の入力
  - 選択肢の追加・編集・削除
  - 質問タイプの設定（単一選択、複数選択、自由記述など）
  - 質問の並び順設定
  - 質問の有効/無効設定

#### 3.2.3 アンケート管理機能
- **機能**: アンケートの作成・編集・削除・管理
- **詳細**:
  - アンケートタイトル・説明文の設定
  - アンケートに質問を紐付け
  - 公開期間の設定（開始日時・終了日時）
  - 公開/非公開の切り替え
  - **URL発行機能**: アンケート作成時にユニークなURLトークンを自動生成
  - **URL共有機能**: 発行されたURLのコピー・共有
  - アンケートの複製機能
  - アンケート一覧表示
  - アンケートの検索・フィルタリング

#### 3.2.4 投票データ管理
- **機能**: 投票データの確認・管理
- **詳細**:
  - 投票データの一覧表示
  - 投票データのエクスポート（CSV、Excel形式）
  - 投票データの削除（必要に応じて）
  - 投票データの検索・フィルタリング

#### 3.2.5 ダッシュボード閲覧
- **機能**: ダッシュボードへのアクセス
- **詳細**:
  - 管理画面からダッシュボードへの遷移
  - リアルタイム可視化の確認

### 3.3 ダッシュボード機能（BIツール）

#### 3.3.1 リアルタイム可視化
- **機能**: 投票状況のリアルタイム表示
- **詳細**:
  - WebSocketまたはServer-Sent Eventsによるリアルタイム更新
  - 投票数のリアルタイムカウント
  - グラフ・チャートの自動更新
  - 更新頻度の設定（1秒、5秒、10秒など）

#### 3.3.2 投票結果の可視化
- **機能**: 投票結果をグラフ・チャートで表示
- **詳細**:
  - 円グラフ（選択肢別の投票数・割合）
  - 棒グラフ（選択肢別の投票数）
  - 時系列グラフ（時間帯別の投票推移）
  - テーブル表示（詳細データ）

#### 3.3.3 投票者分析
- **機能**: 「誰がどこにどのくらい入れているか」の可視化
- **詳細**:
  - 投票者属性別の集計（IPアドレス、デバイス、地域など可能な範囲で）
  - 投票パターンの可視化
  - クロス集計機能（複数質問間の関連性分析）
  - ヒートマップ表示（時間帯×選択肢）

#### 3.3.4 ダッシュボード設定
- **機能**: ダッシュボードの表示設定
- **詳細**:
  - 表示するアンケートの選択
  - 表示する質問の選択
  - グラフタイプの選択
  - 期間フィルタリング
  - ダッシュボードの保存・共有設定

#### 3.3.5 レポート機能
- **機能**: 分析レポートの生成
- **詳細**:
  - レポートの自動生成
  - PDF/Excel形式でのエクスポート
  - レポートのスケジュール実行（定期レポート）

## 4. 非機能要件

### 4.1 パフォーマンス要件
- **同時接続数**: 1,000人以上の同時アクセス・投票に対応
- **レスポンス時間**: 
  - 投票画面の表示: 2秒以内（キャッシュ利用時は1秒以内）
  - 投票処理: 1秒以内
  - ダッシュボード更新: リアルタイム（1秒以内の遅延）
- **スループット**: 1秒あたり100件以上の投票処理
- **データベース負荷**: シンプルなテーブル構造により、高負荷時でもパフォーマンスを維持
- **キャッシュ戦略**: 
  - アンケート情報のキャッシュ（Redis等）
  - 集計結果のキャッシュ（リアルタイム更新時のみ無効化）

### 4.2 可用性要件
- **稼働率**: 99%以上（月間ダウンタイム: 約7時間以内）
- **バックアップ**: 日次自動バックアップ
- **障害復旧**: 24時間以内の復旧

### 4.3 セキュリティ要件
- **認証**: 管理者は強力なパスワード認証
- **通信**: HTTPS通信の必須化
- **投票の整合性**: 重複投票の防止、投票データの改ざん防止
- **データ保護**: 個人情報の適切な管理（必要に応じて）

### 4.4 拡張性要件
- **スケーラビリティ**: 将来的なユーザー数・投票数の増加に対応可能な設計
- **機能拡張**: 新機能の追加が容易な設計

### 4.5 ユーザビリティ要件
- **操作性**: 直感的で使いやすいUI/UX
- **レスポンシブデザイン**: PC・タブレット・スマートフォンに対応
- **アクセシビリティ**: WCAG 2.1 Level AA準拠（推奨）

## 5. データモデル

> **ER図**: 詳細なER図は [ER図.md](./ER図.md) を参照してください。

### 5.1 設計方針
- **シンプルな設計**: 同時1,000人アクセスに対応するため、複雑なリレーションを避け、シンプルなテーブル構造を採用
- **インデックス最適化**: 頻繁にアクセスされるカラムにインデックスを設定
- **正規化**: 必要最小限の正規化（過度な正規化は避ける）

### 5.2 主要エンティティ

#### 5.2.1 アンケート（Survey）
- `id`: アンケートID（主キー、AUTO_INCREMENT）
- `unique_token`: ユニークなURLトークン（UNIQUE INDEX、例: "abc123xyz"）
- `title`: タイトル（VARCHAR(255)）
- `description`: 説明文（TEXT）
- `status`: ステータス（ENUM: 'draft', 'published', 'closed'、INDEX）
- `start_date`: 開始日時（DATETIME、INDEX）
- `end_date`: 終了日時（DATETIME、INDEX）
- `created_at`: 作成日時（DATETIME）
- `updated_at`: 更新日時（DATETIME）
- `created_by`: 作成者ID（外部キー、INDEX）

#### 5.2.2 質問（Question）
- `id`: 質問ID（主キー、AUTO_INCREMENT）
- `survey_id`: アンケートID（外部キー、INDEX）
- `question_text`: 質問文（TEXT）
- `question_type`: 質問タイプ（ENUM: 'single_choice', 'multiple_choice', 'text'）
- `order`: 表示順序（INT、INDEX）
- `is_required`: 必須フラグ（BOOLEAN）
- `created_at`: 作成日時（DATETIME）
- `updated_at`: 更新日時（DATETIME）

#### 5.2.3 選択肢（Option）
- `id`: 選択肢ID（主キー、AUTO_INCREMENT）
- `question_id`: 質問ID（外部キー、INDEX）
- `option_text`: 選択肢テキスト（VARCHAR(500)）
- `order`: 表示順序（INT、INDEX）
- `created_at`: 作成日時（DATETIME）

#### 5.2.4 投票（Vote）
- `id`: 投票ID（主キー、AUTO_INCREMENT）
- `survey_id`: アンケートID（外部キー、INDEX、集計クエリ高速化のため）
- `question_id`: 質問ID（外部キー、INDEX）
- `option_id`: 選択肢ID（外部キー、NULL可、INDEX）
- `answer_text`: 回答テキスト（TEXT、NULL可、自由記述の場合）
- `session_id`: セッションID（VARCHAR(255)、INDEX、重複投票防止用）
- `ip_address`: IPアドレス（VARCHAR(45)、INDEX）
- `user_agent`: ユーザーエージェント（VARCHAR(500)）
- `voted_at`: 投票日時（DATETIME、INDEX）
- `created_at`: 作成日時（DATETIME）

**インデックス戦略**:
- `(survey_id, question_id, option_id)`: 集計クエリ高速化
- `(survey_id, session_id)`: 重複投票チェック高速化
- `(voted_at)`: 時系列分析用

#### 5.2.5 管理者（Admin）
- `id`: 管理者ID（主キー、AUTO_INCREMENT）
- `username`: ユーザー名（VARCHAR(100)、UNIQUE、INDEX）
- `password_hash`: パスワードハッシュ（VARCHAR(255)）
- `email`: メールアドレス（VARCHAR(255)、UNIQUE）
- `role`: 権限（ENUM: 'admin', 'viewer'）
- `created_at`: 作成日時（DATETIME）
- `updated_at`: 更新日時（DATETIME）
- `last_login_at`: 最終ログイン日時（DATETIME）

### 5.3 データリレーション
- アンケート 1:N 質問
- 質問 1:N 選択肢
- 質問 1:N 投票
- 選択肢 1:N 投票
- アンケート 1:N 投票（集計クエリ高速化のため直接リレーション）

### 5.4 データベース最適化
- **パーティショニング**: 投票テーブルは日付でパーティショニング（大量データ時）
- **読み取り専用レプリカ**: ダッシュボード用の読み取り専用レプリカ（オプション）
- **接続プール**: データベース接続プールの設定

## 6. 画面構成

### 6.1 投票者向け画面

#### 6.1.1 投票画面
- **URL**: `/vote/{unique_token}` （例: `/vote/abc123xyz`）
- **機能**: 
  - ユニークなURLトークンによるアクセス（認証不要）
  - アンケート情報の表示
  - 質問と選択肢の表示
  - 投票ボタン
  - 投票完了メッセージ
  - 公開期間外の場合はエラーメッセージ表示

### 6.2 管理画面

#### 6.2.1 ログイン画面
- **URL**: `/admin/login`
- **機能**: 管理者認証

#### 6.2.2 ダッシュボード一覧
- **URL**: `/admin/dashboard`
- **機能**: 
  - アンケート一覧
  - 統計情報の表示
  - ダッシュボードへのリンク

#### 6.2.3 アンケート一覧画面
- **URL**: `/admin/surveys`
- **機能**: 
  - アンケート一覧表示
  - アンケートの作成・編集・削除
  - 検索・フィルタリング

#### 6.2.4 アンケート編集画面
- **URL**: `/admin/surveys/{id}/edit`
- **機能**: 
  - アンケート情報の編集
  - 質問の追加・編集・削除
  - 選択肢の管理
  - **URL発行・表示**: 発行されたユニークURLの表示とコピー機能
  - **URL再発行**: 必要に応じてURLトークンの再発行（旧URLは無効化）

#### 6.2.5 投票データ一覧画面
- **URL**: `/admin/votes`
- **機能**: 
  - 投票データの一覧表示
  - エクスポート機能
  - 検索・フィルタリング

### 6.3 ダッシュボード画面

#### 6.3.1 メインダッシュボード
- **URL**: `/admin/analytics/dashboard`
- **機能**: 
  - リアルタイム投票状況の表示
  - 各種グラフ・チャート
  - フィルタリング機能

#### 6.3.2 詳細分析画面
- **URL**: `/admin/analytics/detail/{survey_id}`
- **機能**: 
  - 特定アンケートの詳細分析
  - クロス集計
  - 時系列分析

## 7. API設計

### 7.1 投票者向けAPI

#### 7.1.1 アンケート取得
- **エンドポイント**: `GET /api/v1/surveys/{unique_token}`
- **説明**: ユニークトークンによる公開中のアンケート情報を取得
- **レスポンス**: 
  ```json
  {
    "id": 1,
    "title": "アンケートタイトル",
    "description": "説明文",
    "questions": [
      {
        "id": 1,
        "question_text": "質問文",
        "question_type": "single_choice",
        "options": [
          {"id": 1, "option_text": "選択肢1"},
          {"id": 2, "option_text": "選択肢2"}
        ]
      }
    ]
  }
  ```

#### 7.1.2 投票送信
- **エンドポイント**: `POST /api/v1/votes`
- **説明**: 投票を送信
- **リクエストボディ**: 
  ```json
  {
    "survey_token": "abc123xyz",
    "question_id": 1,
    "option_id": 2,
    "answer_text": "回答テキスト（自由記述の場合）"
  }
  ```
- **重複投票チェック**: セッションIDとsurvey_idの組み合わせで重複を防止

### 7.2 管理画面API

#### 7.2.1 認証
- **エンドポイント**: `POST /api/v1/admin/auth/login`
- **説明**: 管理者ログイン

#### 7.2.2 アンケート管理
- **エンドポイント**: 
  - `GET /api/v1/admin/surveys` - 一覧取得
  - `POST /api/v1/admin/surveys` - 作成（自動的にunique_tokenを生成）
  - `GET /api/v1/admin/surveys/{id}` - 詳細取得
  - `PUT /api/v1/admin/surveys/{id}` - 更新
  - `DELETE /api/v1/admin/surveys/{id}` - 削除
  - `POST /api/v1/admin/surveys/{id}/regenerate-token` - URLトークンの再発行

#### 7.2.3 質問管理
- **エンドポイント**: 
  - `GET /api/v1/admin/questions` - 一覧取得
  - `POST /api/v1/admin/questions` - 作成
  - `PUT /api/v1/admin/questions/{id}` - 更新
  - `DELETE /api/v1/admin/questions/{id}` - 削除

#### 7.2.4 投票データ取得
- **エンドポイント**: `GET /api/v1/admin/votes`
- **説明**: 投票データの一覧取得（フィルタリング・ページネーション対応）

### 7.3 ダッシュボードAPI

#### 7.3.1 リアルタイムデータ取得
- **エンドポイント**: `GET /api/v1/admin/analytics/realtime`
- **説明**: リアルタイム投票状況の取得
- **WebSocket**: `ws://api/v1/admin/analytics/realtime/stream`

#### 7.3.2 集計データ取得
- **エンドポイント**: `GET /api/v1/admin/analytics/aggregate`
- **説明**: 集計データの取得
- **クエリパラメータ**: 
  - `survey_id`: アンケートID
  - `question_id`: 質問ID
  - `start_date`: 開始日時
  - `end_date`: 終了日時

## 8. 技術要件

### 8.1 フロントエンド
- **フレームワーク**: React / Vue.js / Next.js（いずれか）
- **UIライブラリ**: Material-UI / Ant Design / Tailwind CSS（いずれか）
- **グラフライブラリ**: Chart.js / D3.js / Recharts（いずれか）
- **リアルタイム通信**: WebSocket / Server-Sent Events

### 8.2 バックエンド
- **フレームワーク**: Node.js (Express) / Python (Django/FastAPI) / Ruby on Rails（いずれか）
- **データベース**: PostgreSQL / MySQL（推奨: PostgreSQL、同時1000人アクセス対応）
- **キャッシュ**: Redis（以下用途）
  - セッション管理
  - アンケート情報のキャッシュ（読み取り高速化）
  - 集計結果のキャッシュ
  - リアルタイムデータキャッシュ
- **リアルタイム通信**: Socket.io / WebSocket
- **ロードバランサー**: 複数インスタンス対応（同時1000人アクセス時）

### 8.3 インフラ
- **ホスティング**: クラウドサービス（AWS / GCP / Azure）
- **コンテナ**: Docker（推奨）
- **CI/CD**: GitHub Actions / GitLab CI（推奨）

## 9. セキュリティ考慮事項

### 9.1 投票の整合性
- 重複投票の防止（セッションID + survey_idの組み合わせでチェック）
- 投票データの改ざん防止（サーバー側でのバリデーション）
- 投票期間外の投票を拒否（start_date, end_dateでチェック）
- URLトークンの有効性チェック（存在しないトークンへのアクセス拒否）

### 9.2 データ保護
- 個人情報の適切な管理（必要に応じて匿名化）
- データベースの暗号化
- 通信の暗号化（HTTPS）

### 9.3 アクセス制御
- 管理者認証の強化
- セッション管理
- CSRF対策
- XSS対策

## 10. 運用要件

### 10.1 ログ管理
- アクセスログの記録
- エラーログの記録
- 投票ログの記録

### 10.2 モニタリング
- システムリソースの監視
- パフォーマンス監視
- エラー監視

### 10.3 バックアップ
- データベースの日次バックアップ
- バックアップデータの保存期間: 30日間（推奨）

## 11. 今後の拡張機能（オプション）

### 11.1 機能拡張
- メール通知機能
- SMS通知機能
- 多言語対応
- テンプレート機能（アンケートのテンプレート化）
- 投票結果の公開設定（一般ユーザーへの公開）

### 11.2 分析機能の強化
- 機械学習による投票パターン分析
- 予測分析
- 高度な統計分析

## 12. 開発スケジュール（参考）

### フェーズ1: 基本機能開発（4-6週間）
- データベース設計・構築
- 認証機能
- アンケート・質問管理機能
- 投票機能

### フェーズ2: ダッシュボード開発（3-4週間）
- ダッシュボードUI開発
- リアルタイム可視化機能
- グラフ・チャート機能

### フェーズ3: テスト・調整（2-3週間）
- 統合テスト
- パフォーマンステスト
- セキュリティテスト
- バグ修正

### フェーズ4: 本番環境構築・デプロイ（1-2週間）
- 本番環境構築
- デプロイ
- 運用開始

**合計**: 約10-15週間（2.5-4ヶ月）

---

## 付録

### A. 用語集
- **アンケート**: 複数の質問をまとめた単位
- **質問**: 個別の質問項目
- **選択肢**: 質問に対する回答候補
- **投票**: ユーザーが選択肢を選択する行為
- **ダッシュボード**: 投票結果を可視化する画面

### B. 参考資料
- 要件定義書の更新履歴
- 関連ドキュメントへのリンク

---

**作成日**: 2024年
**最終更新日**: 2024年
**バージョン**: 1.1
**作成者**: [作成者名]

## 更新履歴

### v1.1 (2024年)
- Webアプリケーションとしての明記
- アンケートURL発行機能の追加
- 同時1000人アクセス対応のためのDB設計の簡素化
- パフォーマンス要件の明確化
- キャッシュ戦略の追加
- データモデルの詳細化（データ型、インデックス戦略）

### v1.0 (2024年)
- 初版作成

